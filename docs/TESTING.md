# 🧪 テストガイド

LINE Fitness Bot のテスト方法をまとめたドキュメントです。

## 📋 目次

1. [買い出し計画システムのテスト](#買い出し計画システムのテスト)
2. [スケジューラーのテスト](#スケジューラーのテスト)
3. [手動テスト手順](#手動テスト手順)
4. [トラブルシューティング](#トラブルシューティング)

---

## 🛒 買い出し計画システムのテスト

### 前提条件

- `.env` ファイルに必要な環境変数が設定されていること
- Google Sheets へのアクセス権限があること
- OpenAI API キーが設定されていること

### テストスクリプトの実行

```bash
# 買い出し計画システムの統合テスト
node scripts/test-shopping-plan.js
```

### テスト内容

1. **ShoppingPlan シートの作成/確認**
   - Google Sheets に `ShoppingPlan` シートが作成されるか
   - ヘッダー（Week, UserId, GeneratedAt, ValidFrom, ValidUntil, PlanJSON, Status）が正しいか

2. **DailyMenu シートの作成/確認**
   - Google Sheets に `DailyMenu` シートが作成されるか
   - ヘッダー（Date, Week, Day, Slot, MenuName, IngredientsJSON, Recipe, CookingTime, PFCJSON, SourcePlan）が正しいか

3. **買い出し計画の生成**
   - GPT-4o-mini が買い出し計画を正しく生成するか
   - JSON 形式が正しいか

4. **買い出し計画の保存**
   - Google Sheets に計画が正しく保存されるか

5. **買い出し計画の取得**
   - 有効期間内の計画が正しく取得できるか

6. **日次メニューの生成**
   - 買い出し計画をもとに日次メニューが生成されるか

7. **日次メニューの保存/取得**
   - Google Sheets に日次メニューが正しく保存/取得できるか

### 期待される結果

```
============================================================
🧪 買い出し計画システムのテスト開始
============================================================

📋 Test 1: ShoppingPlanシートの作成確認
------------------------------------------------------------
✅ ShoppingPlanシート作成/ヘッダー確認 完了

📋 Test 2: DailyMenuシートの作成確認
------------------------------------------------------------
✅ DailyMenuシート作成/ヘッダー確認 完了

🤖 Test 3: 買い出し計画の生成（GPT使用）
------------------------------------------------------------
テストユーザーID: U4c1c91fc93ab8a188ab2634eeaa34442
GPTで買い出し計画を生成中...
生成された買い出し計画:
- 目標: cut
- ジム時間帯: morning
- 買い出し頻度: 2
- 買い出し回数: 2
✅ 買い出し計画生成 完了

💾 Test 4: 買い出し計画の保存
------------------------------------------------------------
✅ 買い出し計画を保存しました
   - 有効期間: 2025-10-28 〜 2025-11-03

📖 Test 5: 買い出し計画の取得
------------------------------------------------------------
✅ 有効な買い出し計画を取得しました
   - 週番号: 43
   - 有効期間: 2025-10-28 〜 2025-11-03
   - ステータス: active

🍳 Test 6: 日次メニューの生成（GPT使用）
------------------------------------------------------------
日次メニュー生成中: 2025-10-26 breakfast
生成された日次メニュー:
- メニュー名: オートミール納豆朝食
- 調理時間: 5分
- PFC: {"protein":25,"fat":8,"carbs":45,"calories":350}
✅ 日次メニュー生成 完了

💾 Test 7: 日次メニューの保存
------------------------------------------------------------
✅ 日次メニューを保存しました

📖 Test 8: 日次メニューの取得
------------------------------------------------------------
✅ 保存された日次メニューを取得しました
   - メニュー名: オートミール納豆朝食
   - 調理時間: 5分

============================================================
✅ すべてのテストが完了しました！
============================================================
```

---

## ⏰ スケジューラーのテスト

### 食事プッシュロジックのテスト

```bash
# 食事プッシュのロジックをテスト（実際のLINE通知は送信しない）
node scripts/test-scheduler.js meal
```

このテストでは：
- ユーザー一覧の取得
- 既存の日次メニューの確認
- 買い出し計画の取得
- 日次メニューの生成
- LINE メッセージのフォーマット

をシミュレートします。

### 週次買い出し計画生成のテスト

```bash
# 週次買い出し計画生成のロジックをテスト
node scripts/test-scheduler.js weekly
```

このテストでは：
- ユーザー一覧の取得
- GPT による買い出し計画の生成
- 有効期間の計算

をシミュレートします。

---

## 🖐 手動テスト手順

### 1. Google Sheets の確認

テスト実行後、Google Sheets を開いて以下を確認：

```
https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID
```

**確認ポイント:**
- ✅ `ShoppingPlan` シートが存在する
- ✅ `DailyMenu` シートが存在する
- ✅ ヘッダー行が正しい
- ✅ データ行が追加されている
- ✅ JSON データが正しくエスケープされている

### 2. LINE Bot での動作確認

#### 買い出し計画の手動生成

LINEで以下のコマンドを送信：

```
買い出し計画
```

**期待される動作:**
1. 「生成中...」メッセージが即座に返信される
2. 数秒〜10秒後に買い出し計画のサマリーが届く
3. Google Sheets の `ShoppingPlan` シートに記録される

#### マイページから買い出し計画を確認

1. LINEで「マイページ」と送信
2. マイページを開く
3. 「📋 買い出し計画」ボタンをタップ
4. 最新の買い出し計画が表示される

### 3. スケジューラーの動作確認

#### 方法A: 時刻を待つ（本番確認）

以下の時刻に自動実行されます：
- **7:00 JST**: 朝食メニュープッシュ
- **11:00 JST**: 昼食メニュープッシュ
- **18:00 JST**: 夕食メニュープッシュ
- **月曜 21:00 JST**: 週次買い出し計画生成

#### 方法B: 手動でスケジューラー関数を実行

`services/scheduler.js` の該当関数を一時的にコメントアウトして、直接呼び出すことも可能。

---

## 🔧 トラブルシューティング

### エラー: "Cannot find module"

```bash
npm install
```

### エラー: "GOOGLE_SHEETS_CREDENTIALS_JSON is not set"

`.env` ファイルを確認し、以下の環境変数が設定されているか確認：

```env
GOOGLE_SHEETS_CREDENTIALS_JSON={"type":"service_account",...}
GOOGLE_SHEETS_ID=your_sheet_id
OPENAI_API_KEY=sk-...
```

### エラー: "ShoppingPlan sheet not found"

Google Sheets の権限を確認：
- サービスアカウントにシートの編集権限があるか
- スプレッドシートIDが正しいか

### GPT生成が遅い

- OpenAI APIの状態を確認
- レスポンスタイムアウトを延長（現在は30秒）
- モデルを `gpt-4o-mini` から `gpt-3.5-turbo` に変更（精度は落ちる）

### LINE通知が届かない

- `LINE_CHANNEL_ACCESS_TOKEN` が正しいか確認
- Renderのログを確認（エラーメッセージ）
- LINEのメッセージ送信上限（1日1000通）を確認

---

## 📊 テスト結果の記録

テスト実行時は以下を記録することを推奨：

```markdown
## テスト実行記録

**日時**: 2025-10-26 15:30
**環境**: Render Production
**テスター**: [Your Name]

### 結果

- [x] ShoppingPlanシート作成
- [x] DailyMenuシート作成
- [x] 買い出し計画生成（約8秒）
- [x] 日次メニュー生成（約6秒）
- [x] Google Sheetsへの保存
- [ ] LINE通知（要確認）

### 問題点

- 買い出し計画の生成に10秒以上かかることがある
- 一部の食材名が英語で出力される

### 次のアクション

- GPTプロンプトを調整して日本語を強制
- キャッシュ機構の導入を検討
```

---

## 🎯 推奨テストフロー

1. **ローカル開発時**:
   ```bash
   node scripts/test-shopping-plan.js
   node scripts/test-scheduler.js meal
   ```

2. **デプロイ前**:
   - 全テストスクリプトを実行
   - Google Sheetsを手動確認
   - Lintエラーチェック

3. **デプロイ後**:
   - LINE Botで「買い出し計画」コマンドをテスト
   - マイページで買い出し計画表示を確認
   - 翌朝のプッシュ通知を確認

---

## 📚 関連ドキュメント

- [README.md](../README.md) - プロジェクト概要
- [.cursorrules](../.cursorrules) - 開発ガイドライン
- [user-manual.md](./user-manual.md) - ユーザーマニュアル

