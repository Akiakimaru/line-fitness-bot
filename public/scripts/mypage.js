// „Éû„Ç§„Éö„Éº„Ç∏Â∞ÇÁî®JavaScript - LINE Fitness Bot

// URL„Éë„É©„É°„Éº„Çø„ÇíÂèñÂæó
const params = getUrlParams();
const { uid, exp, sig } = params;

console.log('MyPage params:', { uid, exp, sig });

// „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„ÇíË°®Á§∫
if (!uid || !exp || !sig) {
  showDebugInfo('URL„Éë„É©„É°„Éº„Çø„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô', { uid, exp, sig });
}

/**
 * LINE Bot„ÅÆË™¨Êòé„ÇíË°®Á§∫
 */
function openLineBot() {
  alert('LINE Bot„Åß„Äå„Éû„Ç§„Éö„Éº„Ç∏„Äç„Å®ÈÄÅ‰ø°„Åô„Çã„Å®„ÄÅ„Åì„ÅÆ„Éö„Éº„Ç∏„Å´„Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Åæ„Åô„ÄÇ');
}

/**
 * ‰ªäÊó•„ÅÆ„É°„Éã„É•„Éº„ÅÆË™¨Êòé„ÇíË°®Á§∫
 */
function showTodayMenu() {
  alert('LINE Bot„Åß„Äå‰ªäÊó•„ÅÆ„É°„Éã„É•„Éº„Äç„Å®ÈÄÅ‰ø°„Åô„Çã„Å®„ÄÅÂΩìÊó•„ÅÆ„É°„Éã„É•„Éº„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ');
}

/**
 * „Ç∏„É†„É°„Éã„É•„Éº„ÇíÈñã„Åè
 */
function openGymMenu() {
  if (!uid || !exp || !sig) {
    alert('URL„Éë„É©„É°„Éº„Çø„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ');
    return;
  }
  const url = `/gym-menu?uid=${encodeURIComponent(uid)}&exp=${encodeURIComponent(exp)}&sig=${encodeURIComponent(sig)}`;
  window.open(url, '_blank');
}

/**
 * ÁÆ°ÁêÜÁîªÈù¢„ÇíÈñã„Åè
 */
function openAdminPanel() {
  const adminKey = prompt('ÁÆ°ÁêÜÁîªÈù¢„Å´„Ç¢„ÇØ„Çª„Çπ„Åô„Çã„Å´„ÅØÁÆ°ÁêÜËÄÖ„Ç≠„Éº„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ\\nÁÆ°ÁêÜËÄÖ„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
  if (adminKey) {
    window.open(`/admin?key=${encodeURIComponent(adminKey)}`, '_blank');
  }
}

/**
 * „Éá„Éê„ÉÉ„Ç∞„Éö„Éº„Ç∏„ÇíÈñã„ÅèÔºà„Éë„É©„É°„Éº„Çø„ÇíÂºï„ÅçÁ∂ô„ÅêÔºâ
 */
function openDebugPage() {
  if (!uid || !exp || !sig) {
    alert('URL„Éë„É©„É°„Éº„Çø„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ');
    return;
  }
  const url = `/debug.html?uid=${encodeURIComponent(uid)}&exp=${encodeURIComponent(exp)}&sig=${encodeURIComponent(sig)}`;
  window.open(url, '_blank');
}

/**
 * Ë≤∑„ÅÑÂá∫„ÅóË®àÁîª„ÇíÈñã„Åè
 */
function openShoppingPlan() {
  if (!uid || !exp || !sig) {
    alert('URL„Éë„É©„É°„Éº„Çø„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ');
    return;
  }
  const url = `/shopping-plan-view?uid=${encodeURIComponent(uid)}&exp=${encodeURIComponent(exp)}&sig=${encodeURIComponent(sig)}`;
  window.open(url, '_blank');
}

/**
 * ‰Ωø„ÅÑÊñπ„Ç¨„Ç§„Éâ„ÇíÈñã„Åè
 */
function openGuide() {
  if (!uid || !exp || !sig) {
    alert('URL„Éë„É©„É°„Éº„Çø„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ');
    return;
  }
  const url = `/guide?uid=${encodeURIComponent(uid)}&exp=${encodeURIComponent(exp)}&sig=${encodeURIComponent(sig)}`;
  window.open(url, '_blank');
}

/**
 * È£üÂìÅ„Éá„Éº„Çø„Éô„Éº„Çπ„ÇíÈñã„Åè
 */
function openFoodDB() {
  if (!uid || !exp || !sig) {
    alert('URL„Éë„É©„É°„Éº„Çø„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ');
    return;
  }
  const url = `/food-db?uid=${encodeURIComponent(uid)}&exp=${encodeURIComponent(exp)}&sig=${encodeURIComponent(sig)}`;
  window.open(url, '_blank');
}

/**
 * „Éá„Éº„Çø„ÇíÂÜçË™≠„ÅøËæº„Åø
 */
function refreshData() {
  loadData();
}

/**
 * „É°„Ç§„É≥„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÈñ¢Êï∞
 */
async function loadData() {
  try {
    updateStatus('status-message', '„Éá„Éº„ÇøË™≠„ÅøËæº„Åø‰∏≠...', 'info');
    
    if (!uid || !exp || !sig) {
      throw new Error('URL„Éë„É©„É°„Éº„Çø„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô: uid=' + uid + ', exp=' + exp + ', sig=' + sig);
    }
    
    console.log('Loading data for uid:', uid);
    
    const summaryUrl = `/user/summary?uid=${encodeURIComponent(uid)}&exp=${encodeURIComponent(exp)}&sig=${encodeURIComponent(sig)}`;
    const logsUrl = `/user/logs?uid=${encodeURIComponent(uid)}&exp=${encodeURIComponent(exp)}&sig=${encodeURIComponent(sig)}&days=8`;
    
    console.log('API URLs:', { summaryUrl, logsUrl });
    
    const [summary, logs] = await Promise.all([
      apiCall(summaryUrl),
      apiCall(logsUrl)
    ]);
    
    console.log('API responses:', { summary, logs });
    console.log('Summary ok:', summary.ok, 'Logs ok:', logs.ok);
    
    if (!summary.ok) {
      throw new Error('summary failed: ' + (summary.error || 'Unknown error'));
    }
    if (!logs.ok) {
      throw new Error('logs failed: ' + (logs.error || 'Unknown error'));
    }
    
    // KPIÊõ¥Êñ∞
    console.log('Updating KPIs:', { 
      meals: summary.data?.meals, 
      gymSets: summary.data?.gymSets, 
      weightCount: logs.data?.logs?.filter(l => l.Kind === 'Weight').length 
    });
    
    document.getElementById('meal-count').textContent = summary.data?.meals || 0;
    document.getElementById('gym-count').textContent = summary.data?.gymSets || 0;
    document.getElementById('weight-count').textContent = logs.data?.logs?.filter(l => l.Kind === 'Weight').length || 0;
    
    // „Ç∞„É©„ÉïÊèèÁîª
    renderCharts(logs, summary);
    
    // PFC„Çµ„Éû„É™„ÉºË®àÁÆó
    const mealLogs = logs.data?.logs?.filter(l => l.Kind === 'Meal' && l.PFC && l.PFC.total) || [];
    let totalProtein = 0, totalFat = 0, totalCarbs = 0, totalCalories = 0;
    mealLogs.forEach(log => {
      if (log.PFC && log.PFC.total) {
        totalProtein += log.PFC.total.protein || 0;
        totalFat += log.PFC.total.fat || 0;
        totalCarbs += log.PFC.total.carbs || 0;
        totalCalories += log.PFC.total.calories || 0;
      }
    });
    
    // PFC„Çµ„Éû„É™„Éº„ÇíË°®Á§∫ÔºàÁ∞°ÊòìÁâàÔºâ
    if (mealLogs.length > 0) {
      const pfcSummary = document.createElement('div');
      pfcSummary.innerHTML = 
        '<div style="background: #e8f5e8; padding: 12px; border-radius: 8px; margin: 12px 0; font-size: 12px;">' +
          '<strong>üìä 7Êó•ÈñìPFCÂêàË®à</strong><br>' +
          'P: ' + totalProtein.toFixed(1) + 'g | F: ' + totalFat.toFixed(1) + 'g | C: ' + totalCarbs.toFixed(1) + 'g<br>' +
          '„Ç´„É≠„É™„Éº: ' + totalCalories.toFixed(0) + 'kcal (Âπ≥Âùá: ' + (totalCalories/7).toFixed(0) + 'kcal/Êó•)' +
        '</div>';
      document.querySelector('.logs-section').insertBefore(pfcSummary, document.getElementById('status-message'));
    }
    
    // ÈÄ£Á∂öË®òÈå≤Êó•Êï∞ÔºàÁ∞°ÊòìÁâàÔºâ
    const today = new Date();
    const recentDays = new Set();
    (logs.data?.logs || []).forEach(log => {
      const logDate = new Date(log.DateTime).toDateString();
      recentDays.add(logDate);
    });
    document.getElementById('streak-days').textContent = recentDays.size;
    
    // „É≠„Ç∞Ë°®Á§∫ÔºàÊúÄÊñ∞È†Ü„Å´„ÇΩ„Éº„ÉàÔºâ
    const tbody = document.getElementById('logs-tbody');
    tbody.innerHTML = '';
    
    if ((logs.data?.logs || []).length === 0) {
      updateStatus('status-message', 'Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇLINE Bot„ÅßË®òÈå≤„ÇíÈñãÂßã„Åó„Åæ„Åó„Çá„ÅÜÔºÅ', 'warning');
    } else {
      updateStatus('status-message', '„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü', 'good');
      document.getElementById('logs-table').style.display = 'table';
      
      // ÊúÄÊñ∞È†Ü„Å´„ÇΩ„Éº„ÉàÔºàDateTimeÈôçÈ†ÜÔºâ
      const sortedLogs = (logs.data?.logs || []).sort((a, b) => new Date(b.DateTime) - new Date(a.DateTime));
      
      sortedLogs.slice(0, 30).forEach(r => {
        const tr = document.createElement('tr');
        const td1 = document.createElement('td'); 
        td1.textContent = formatJST(r.DateTime); 
        tr.appendChild(td1);
        
        const td2 = document.createElement('td'); 
        const kindEmoji = r.Kind === 'Meal' ? 'üçΩ' : r.Kind === 'Gym' ? 'üí™' : '‚öñÔ∏è';
        td2.textContent = kindEmoji + ' ' + r.Kind; 
        tr.appendChild(td2);
        
        const td3 = document.createElement('td'); 
        let content = r.Text;
        // PFCÊÉÖÂ†±„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØËøΩÂä†Ë°®Á§∫
        if (r.Kind === 'Meal' && r.PFC && r.PFC.total) {
          const { protein, fat, carbs, calories } = r.PFC.total;
          content += '\nüìä P' + protein + 'g F' + fat + 'g C' + carbs + 'g (' + calories + 'kcal)';
        }
        td3.textContent = content; 
        tr.appendChild(td3);
        
        tbody.appendChild(tr);
      });
    }
    
  } catch (error) {
    handleError(error, 'loadData');
    updateStatus('status-message', '„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'warning');
  }
}

/**
 * „Ç∞„É©„ÉïÊèèÁîª
 */
let weightChartInstance = null;
let pfcChartInstance = null;

function renderCharts(logs, summary) {
  renderWeightChart(logs);
  renderPFCChart(logs);
  renderGymHeatmap(logs);
}

/**
 * ‰ΩìÈáçÊé®Áßª„Ç∞„É©„Éï
 */
function renderWeightChart(logs) {
  const ctx = document.getElementById('weightChart');
  if (!ctx) return;
  
  // ‰ΩìÈáç„Éá„Éº„Çø„ÇíÊäΩÂá∫Ôºà30Êó•ÈñìÔºâ
  const weightLogs = (logs.data?.logs || [])
    .filter(l => l.Kind === 'Weight')
    .sort((a, b) => new Date(a.DateTime) - new Date(b.DateTime))
    .slice(-30);
  
  const labels = weightLogs.map(l => {
    const date = new Date(l.DateTime);
    return `${date.getMonth() + 1}/${date.getDate()}`;
  });
  
  const data = weightLogs.map(l => parseFloat(l.Text));
  
  // Êó¢Â≠ò„ÅÆ„ÉÅ„É£„Éº„Éà„ÇíÁ†¥Ê£Ñ
  if (weightChartInstance) {
    weightChartInstance.destroy();
  }
  
  weightChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: '‰ΩìÈáç (kg)',
        data: data,
        borderColor: '#F59E0B',
        backgroundColor: 'rgba(245, 158, 11, 0.1)',
        tension: 0.4,
        fill: true,
        pointRadius: 4,
        pointHoverRadius: 6,
        pointBackgroundColor: '#F59E0B',
        pointBorderColor: '#fff',
        pointBorderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          padding: 12,
          titleFont: { size: 14 },
          bodyFont: { size: 13 },
          callbacks: {
            label: function(context) {
              return `‰ΩìÈáç: ${context.parsed.y.toFixed(1)} kg`;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: false,
          ticks: {
            callback: function(value) {
              return value + ' kg';
            }
          },
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          }
        },
        x: {
          grid: {
            display: false
          }
        }
      }
    }
  });
}

/**
 * PFCÊé®Áßª„Ç∞„É©„ÉïÔºàÈÄ±ÈñìÔºâ
 */
function renderPFCChart(logs) {
  const ctx = document.getElementById('pfcChart');
  if (!ctx) return;
  
  // ÈÅéÂéª7Êó•Èñì„ÅÆÊó•‰ªò„ÇíÁîüÊàê
  const days = [];
  for (let i = 6; i >= 0; i--) {
    const date = new Date();
    date.setDate(date.getDate() - i);
    days.push(date);
  }
  
  const labels = days.map(d => `${d.getMonth() + 1}/${d.getDate()}`);
  
  // ÂêÑÊó•„ÅÆPFC„ÇíÈõÜË®à
  const proteinData = [];
  const fatData = [];
  const carbData = [];
  
  days.forEach(day => {
    const dayStr = day.toISOString().split('T')[0];
    const dayLogs = (logs.data?.logs || []).filter(l => {
      if (l.Kind !== 'Meal') return false;
      const logDate = new Date(l.DateTime).toISOString().split('T')[0];
      return logDate === dayStr;
    });
    
    let totalP = 0, totalF = 0, totalC = 0;
    dayLogs.forEach(log => {
      if (log.PFC && log.PFC.total) {
        totalP += log.PFC.total.protein || 0;
        totalF += log.PFC.total.fat || 0;
        totalC += log.PFC.total.carbs || 0;
      }
    });
    
    proteinData.push(totalP);
    fatData.push(totalF);
    carbData.push(totalC);
  });
  
  // Êó¢Â≠ò„ÅÆ„ÉÅ„É£„Éº„Éà„ÇíÁ†¥Ê£Ñ
  if (pfcChartInstance) {
    pfcChartInstance.destroy();
  }
  
  pfcChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: '„Çø„É≥„Éë„ÇØË≥™ (g)',
          data: proteinData,
          backgroundColor: 'rgba(59, 130, 246, 0.8)',
          borderRadius: 6
        },
        {
          label: 'ËÑÇË≥™ (g)',
          data: fatData,
          backgroundColor: 'rgba(245, 158, 11, 0.8)',
          borderRadius: 6
        },
        {
          label: 'ÁÇ≠Ê∞¥ÂåñÁâ© (g)',
          data: carbData,
          backgroundColor: 'rgba(16, 185, 129, 0.8)',
          borderRadius: 6
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'top',
          labels: {
            boxWidth: 12,
            font: { size: 11 }
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          padding: 12
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          stacked: false,
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          }
        },
        x: {
          stacked: false,
          grid: {
            display: false
          }
        }
      }
    }
  });
}

/**
 * „Ç∏„É†„É≠„Ç∞Áî®„ÅÆÊó•‰ªòÊèõÁÆóÔºàAM5ÊôÇÂü∫Ê∫ñÔºâ- „ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂÅ¥
 * AM5:00„ÄúÁøåÊó•AM4:59„Åæ„Åß„ÇíÂêå„ÅòÊó•„Å®„Åó„Å¶ÊèõÁÆó
 */
function convertToGymDateClient(dateTime) {
  const dt = new Date(dateTime);
  
  // ÊôÇÂàª„Åå0:00„Äú4:59„ÅÆÂ†¥Âêà„ÅØÂâçÊó•Êâ±„ÅÑ
  const hour = dt.getHours();
  if (hour < 5) {
    dt.setDate(dt.getDate() - 1);
  }
  
  // YYYY-MM-DDÂΩ¢Âºè„ÅßËøî„Åô
  return dt.toISOString().split('T')[0];
}

/**
 * „Ç∏„É†„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„Éí„Éº„Éà„Éû„ÉÉ„Éó
 */
function renderGymHeatmap(logs) {
  const container = document.getElementById('gym-heatmap');
  if (!container) return;
  
  // ÈÅéÂéª30Êó•Èñì„ÅÆÊó•‰ªò„ÇíÁîüÊàê
  const days = [];
  for (let i = 29; i >= 0; i--) {
    const date = new Date();
    date.setDate(date.getDate() - i);
    days.push(date);
  }
  
  // ÂêÑÊó•„ÅÆ„Ç∏„É†Ë®òÈå≤„Çí„Ç´„Ç¶„É≥„ÉàÔºàAM5ÊôÇÂü∫Ê∫ñ„ÅßÊèõÁÆóÔºâ
  const gymCounts = {};
  days.forEach(day => {
    const dayStr = day.toISOString().split('T')[0];
    const dayGymLogs = (logs.data?.logs || []).filter(l => {
      if (l.Kind !== 'Gym') return false;
      // AM5ÊôÇÂü∫Ê∫ñ„ÅßÊó•‰ªò„ÇíÊèõÁÆó
      const gymDate = convertToGymDateClient(l.DateTime);
      return gymDate === dayStr;
    });
    gymCounts[dayStr] = dayGymLogs.length;
  });
  
  // „Éí„Éº„Éà„Éû„ÉÉ„Éó„ÇíÊèèÁîª
  container.innerHTML = '';
  
  // ÊõúÊó•„É©„Éô„É´
  const weekDays = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
  
  days.forEach(day => {
    const dayStr = day.toISOString().split('T')[0];
    const count = gymCounts[dayStr] || 0;
    
    // Âº∑Â∫¶„Å´Âøú„Åò„ÅüËâ≤
    let bgColor = 'bg-gray-100';
    let textColor = 'text-gray-400';
    let tooltip = 'Ë®òÈå≤„Å™„Åó';
    
    if (count > 0) {
      bgColor = 'bg-green-200';
      textColor = 'text-green-800';
      tooltip = `${count}Âõû`;
    }
    if (count >= 2) {
      bgColor = 'bg-green-400';
      textColor = 'text-white';
    }
    if (count >= 3) {
      bgColor = 'bg-green-600';
      textColor = 'text-white';
    }
    
    const cell = document.createElement('div');
    cell.className = `${bgColor} ${textColor} rounded-lg p-3 text-center text-xs font-semibold hover:scale-110 transition-transform cursor-pointer`;
    cell.title = `${day.getMonth() + 1}/${day.getDate()} (${weekDays[day.getDay()]}): ${tooltip}`;
    cell.dataset.date = dayStr; // Êó•‰ªò„ÇídataÂ±ûÊÄß„Å´‰øùÂ≠ò
    cell.innerHTML = `
      <div class="text-[10px] opacity-75">${day.getDate()}</div>
      <div class="text-lg">${count > 0 ? 'üí™' : '¬∑'}</div>
    `;
    
    // „ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„ÉàÔºàË®òÈå≤„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„ÅøÔºâ
    if (count > 0) {
      cell.addEventListener('click', () => showGymDetail(dayStr));
    }
    
    container.appendChild(cell);
  });
}

/**
 * „Ç∏„É†„É≠„Ç∞Ë©≥Á¥∞„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
 */
async function showGymDetail(date) {
  try {
    const params = new URLSearchParams(window.location.search);
    const uid = params.get('uid');
    const exp = params.get('exp');
    const sig = params.get('sig');
    
    console.log(`[showGymDetail] Fetching detail for date: ${date}`);
    
    // API„Åã„ÇâË©≥Á¥∞„Éá„Éº„Çø„ÇíÂèñÂæó
    const response = await fetch(`/user/gym-detail?uid=${uid}&exp=${exp}&sig=${sig}&date=${date}`);
    const result = await response.json();
    
    if (!response.ok || !result.ok) {
      throw new Error(result.message || '„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
    }
    
    const data = result.data;
    console.log('[showGymDetail] Received data:', data);
    
    // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
    displayGymDetailModal(data);
    
  } catch (error) {
    console.error('[showGymDetail] Error:', error);
    alert('„Ç∏„É†„É≠„Ç∞„ÅÆË©≥Á¥∞ÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
  }
}

/**
 * „Ç∏„É†„É≠„Ç∞Ë©≥Á¥∞„É¢„Éº„ÉÄ„É´„ÅÆË°®Á§∫
 */
function displayGymDetailModal(data) {
  // Êó¢Â≠ò„ÅÆ„É¢„Éº„ÉÄ„É´„ÇíÂâäÈô§
  const existingModal = document.getElementById('gym-detail-modal');
  if (existingModal) {
    existingModal.remove();
  }
  
  // Êó•‰ªò„ÇíÊï¥ÂΩ¢
  const dateObj = new Date(data.date + 'T00:00:00');
  const dateStr = `${dateObj.getMonth() + 1}Êúà${dateObj.getDate()}Êó•`;
  
  // „É¢„Éº„ÉÄ„É´HTMLÁîüÊàê
  const modalHTML = `
    <div id="gym-detail-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm" onclick="closeGymDetailModal(event)">
      <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <div class="bg-gradient-to-r from-green-500 to-emerald-600 p-6 text-white rounded-t-2xl">
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold">üí™ „Ç∏„É†„É≠„Ç∞Ë©≥Á¥∞</h2>
              <p class="text-green-100 mt-1">${dateStr}</p>
            </div>
            <button onclick="closeGymDetailModal()" class="text-white hover:bg-white/20 rounded-full p-2 transition-colors">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
        </div>
        
        <!-- „Çµ„Éû„É™„Éº -->
        <div class="p-6 border-b border-gray-200">
          <div class="grid grid-cols-2 gap-4">
            <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4">
              <div class="text-sm text-blue-600 font-medium">Á∑è„Çª„ÉÉ„ÉàÊï∞</div>
              <div class="text-3xl font-bold text-blue-700 mt-1">${data.totalSets}</div>
            </div>
            <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-4">
              <div class="text-sm text-purple-600 font-medium">Á∑è„Éà„É¨ÊôÇÈñì</div>
              <div class="text-3xl font-bold text-purple-700 mt-1">${data.totalMinutes}<span class="text-lg">ÂàÜ</span></div>
            </div>
          </div>
        </div>
        
        <!-- Á®ÆÁõÆÂà•Ë©≥Á¥∞ -->
        <div class="p-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">üìã ÂÆüÊñΩÁ®ÆÁõÆ</h3>
          ${data.exercises.length > 0 ? `
            <div class="space-y-3">
              ${data.exercises.map(ex => `
                <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl p-4 border border-gray-200">
                  <div class="flex justify-between items-start">
                    <div class="flex-1">
                      <div class="font-bold text-gray-800">${ex.name}</div>
                      <div class="text-sm text-gray-600 mt-1">
                        ${ex.sets}„Çª„ÉÉ„Éà
                        ${ex.avgReps ? ` ¬∑ Âπ≥Âùá${ex.avgReps}Âõû` : ''}
                        ${ex.avgWeight ? ` ¬∑ Âπ≥Âùá${ex.avgWeight}kg` : ''}
                      </div>
                    </div>
                  </div>
                  ${ex.reps && ex.reps.length > 0 ? `
                    <div class="mt-2 flex flex-wrap gap-2">
                      ${ex.reps.map((rep, idx) => `
                        <span class="bg-white px-3 py-1 rounded-full text-xs font-medium text-gray-700 border border-gray-300">
                          ${rep}Âõû${ex.weights && ex.weights[idx] ? ` √ó ${ex.weights[idx]}kg` : ''}
                        </span>
                      `).join('')}
                    </div>
                  ` : ''}
                </div>
              `).join('')}
            </div>
          ` : '<p class="text-gray-500 text-center py-8">Á®ÆÁõÆ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>'}
        </div>
        
        <!-- Áîü„É≠„Ç∞ -->
        ${data.logs.length > 0 ? `
          <div class="p-6 bg-gray-50 rounded-b-2xl">
            <details class="cursor-pointer">
              <summary class="text-sm font-medium text-gray-700 hover:text-gray-900">üìù Ë®òÈå≤Ë©≥Á¥∞„ÇíË°®Á§∫</summary>
              <div class="mt-4 space-y-3">
                ${data.logs.map((log, idx) => `
                  <div class="bg-white rounded-lg p-4 border border-gray-200">
                    <div class="text-xs text-gray-500 mb-2">Ë®òÈå≤${idx + 1} - ${new Date(log.dateTime).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })}</div>
                    <div class="text-sm text-gray-800 whitespace-pre-wrap font-mono">${log.text}</div>
                    ${log.meta && (log.meta.sets || log.meta.minutes) ? `
                      <div class="text-xs text-gray-600 mt-2">
                        ${log.meta.sets ? `${log.meta.sets}„Çª„ÉÉ„Éà` : ''} ${log.meta.minutes ? `${log.meta.minutes}ÂàÜ` : ''}
                      </div>
                    ` : ''}
                  </div>
                `).join('')}
              </div>
            </details>
          </div>
        ` : ''}
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHTML);
}

/**
 * „Ç∏„É†„É≠„Ç∞Ë©≥Á¥∞„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
 */
function closeGymDetailModal(event) {
  const modal = document.getElementById('gym-detail-modal');
  if (modal && (!event || event.target === modal)) {
    modal.remove();
  }
}

// „Ç∞„É≠„Éº„Éê„É´„Å´ÂÖ¨ÈñãÔºàHTMLÂÜÖ„ÅÆonclick„Åã„ÇâÂëº„Å≥Âá∫„Åô„Åü„ÇÅÔºâ
window.closeGymDetailModal = closeGymDetailModal;

// ÂàùÊúüË™≠„ÅøËæº„Åø
loadData();
